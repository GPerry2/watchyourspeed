function getFormValues(e){var t=$(e).serializeArray(),i=[];return $.each(t,function(e,t){JSON.stringify(t).indexOf("[template]")<0&&i.push(t)}),i}function CotForm(e){if(!e)throw new Error("You must supply a form definition");this._isRendered=!1,this._definition=e,this._useBinding=e.useBinding||!1,this._model=null,this.cotForm=new cot_form({id:e.id||"new_form",title:e.title,success:e.success||function(){}});var t=this,i=["text","dropdown","textarea","checkbox","radio"];$.each(e.sections||[],function(e,a){var d=t.cotForm.addSection({id:a.id||"section"+e,title:a.title,className:a.className});$.each(a.rows||[],function(e,t){t.fields?(t.fields.forEach(function(e){var t=e.type||"text";if(e.bindTo&&i.indexOf(t)===-1)throw new Error("Error in field "+(e.id||"no id")+", fields of type "+t+" cannot use bindTo.")}),d.addRow(t.fields)):t.grid&&d.addGrid(t.grid)})})}var browser=navigator.userAgent,IEversion=99;IEversion=browser.indexOf("MSIE")>1?parseInt(browser.substr(browser.indexOf("MSIE")+5,5)):IEversion;var cot_form=function(e){this.id=e.id,this.title=e.title,this.success=e.success,this.sections=[]};cot_form.addDefaultFieldProperties=function(e){return cot_form.fixClassProperty(e),(e||[]).forEach(function(e){if(e.type=e.type||"text",e.id=e.id||Math.random().toString().split(".")[1],["radio","checkbox","dropdown","multiselect"].indexOf(e.type)>-1&&!$.isArray(e.choices))throw new Error("Error in field "+e.id+": choices property is missing or invalid")}),e},cot_form.fixClassProperty=function(e){$.each($.makeArray(e||[]),function(e,t){void 0===t.className&&"string"==typeof t.class&&(t.className=t.class,delete t.class)})};var cot_section=function(e){cot_form.fixClassProperty(e),this.id=e.id,this.title=e.title,this.className=e.className,this.rows=[]},cot_row=function(e){this.fields=cot_form.addDefaultFieldProperties(e),this.type="standard"},cot_grid=function(e){cot_form.fixClassProperty(e),this.id=e.id?e.id:"grid-"+Math.floor(1e8*Math.random()),this.add=!!e.add,this.className=e.className,this.title=e.title,this.headers=e.headers,this.fields=cot_form.addDefaultFieldProperties(e.fields),this.type="grid"};cot_form.prototype.addSection=function(e){return e instanceof cot_section||(e=new cot_section(e)),this.sections.push(e),e},cot_section.prototype.addRow=function(e){return e instanceof cot_row||(e=new cot_row(e)),this.rows.push(e),this},cot_section.prototype.addGrid=function(e){return e instanceof cot_grid||(e=new cot_grid(e)),this.rows.push(e),this},cot_form.prototype.render=function(e){var t=this,i={fields:{}},a=document.createElement("form");if(a.id=this.id,a.setAttribute("data-fv-framework","bootstrap"),a.setAttribute("data-fv-icon-valid","glyphicon glyphicon-ok"),a.setAttribute("data-fv-icon-invalid","glyphicon glyphicon-remove"),a.setAttribute("data-fv-icon-validating","glyphicon glyphicon-refresh"),this.title){a.appendChild(document.createElement("h2")).textContent=this.title}$.each(this.sections,function(e,d){var n=a.appendChild(document.createElement("div"));if(n.id=d.id,n.className=void 0!==d.className?"panel "+d.className:"panel panel-default",d.title){var r=n.appendChild(document.createElement("div"));r.className="panel-heading";var o=r.appendChild(document.createElement("h3"));o.appendChild(document.createElement("span")).className="glyphicon glyphicon-th-large",o.appendChild(document.createElement("span")),o.textContent=d.title}var l=n.appendChild(document.createElement("div"));l.className="panel-body",$.each(d.rows,function(e,a){var d=l.appendChild(document.createElement("div"));d.className="row","grid"==a.type?t.processGrid(d,i,a):$.each(a.fields,function(e,n){t.processField(d,i,a,n)})})}),$(e.target).append(a),t.initializeFunctions();var d=$("#"+this.id);d.formValidation($.extend({excluded:[":not(.multiselect):disabled",":not(.multiselect):hidden",":not(.multiselect):not(:visible)"],feedbackIcons:{valid:"glyphicon glyphicon-ok",invalid:"glyphicon glyphicon-remove",validating:"glyphicon glyphicon-refresh"},onSuccess:this.success,onError:function(e){console.log("Validation error occurred:",e),$($(".has-error input, .has-error select, .has-error button")[0]).focus()},fields:i.fields},e.formValidationSettings||{})),d.find("button.fv-hidden-submit").text("hidden submit button"),d.find("button.fv-hidden-submit").attr("aria-hidden",!0)},cot_form.prototype.initializeFunctions=function(){var e=this.id,t=void 0===window.cot_bower_enabled?"../corev1.1/":"";$.each(this.sections,function(i,a){$.each(a.rows,function(i,a){$.each(a.fields,function(i,a){"button"==a.type&&$("#"+a.id).click(function(){a.onclick()}),"multiselect"==a.type&&$("."+a.id+".multiselect").multiselect(a.options),"Phone"==a.validationtype&&$(".phonevalidation").intlTelInput({utilsScript:t+"js/utils.js",autoPlaceholder:!1,preferredCountries:["ca"]}),"daterangepicker"==a.type&&$(".daterangevalidation").daterangepicker(a.options).on("show.daterangepicker",function(e,t){$($(t)[0]).focus()}),"datetimepicker"==a.type&&$("."+a.id+".datetimepicker").datetimepicker(a.options).on("dp.change",function(){var t=$(this).attr("data-refid");$("#"+e).data("formValidation").updateStatus(t,"NOT_VALIDATED").validateField(t)})})})}),$('[data-toggle="tooltip"]').tooltip({html:!0,trigger:"click hover"})},cot_form.prototype.processGrid=function(e,t,i){var a,d=this,n=e.appendChild(document.createElement("div"));n.id=i.id,n.className="grid-object table-responsive ",n.className+=i.className||"",n.className+=i.addclass?" "+i.addclass:"",d[n.id+"-index"]=0;var r=n.appendChild(document.createElement("h4"));r.className="grid-title",r.textContent=i.title;var o=n.appendChild(document.createElement("table"));o.className="grid-table table table-striped";var l=o.appendChild(document.createElement("tr"));$.each(i.headers,function(e,t){var a=l.appendChild(document.createElement("th"));a.textContent=t.title,a.id=i.id+"_"+e}),oTH=l.appendChild(document.createElement("th"));var s=oTH.appendChild(document.createElement("span"));s.className="sr-only",s.textContent="Add/Remove Rows",l=o.appendChild(document.createElement("tr")),l.id=i.id+"-row-0",l.setAttribute("data-row-index","0"),$.each(i.fields,function(e,a){var n=l.appendChild(document.createElement("td"));n.className="form-group",n.className+=a.addclass?" "+a.addclass:"",a.grid="0",a.gridlabel=i.id+"_"+e,d.addformfield(d,a,n);var r=a.id;a.id="row[0]."+a.id,d.addfieldvalidation(t,a),a.id=r});var c=l.appendChild(document.createElement("td"));c.className="text-right",a=c.appendChild(document.createElement("button")),a.className="btn btn-default grid-add",a.type="button",a.onclick=function(){d[n.id+"-index"]++;var e=$("#"+n.id+"-template"),t=e.clone().removeClass("hide").attr("id",n.id+"-row-"+d[n.id+"-index"]).attr("data-row-index",d[n.id+"-index"]);t.html(t.html().replace(/template/g,d[n.id+"-index"])),t.insertBefore(e),t.find(".grid-minus").click(function(){var e=$(this).parents("tr"),t=e.find("input");e.remove(),$("#"+d.id).formValidation("removeField",t)});var i=t.find(".form-control");$.each(i,function(e,t){$("#"+d.id).formValidation("addField",$(t),$("#"+d.id).data("formValidation").options.fields[t.name.substring(t.name.lastIndexOf(".")+1)])}),d.initializeFunctions()},a.appendChild(document.createElement("span")).className="glyphicon glyphicon-plus";var s=a.appendChild(document.createElement("span"));s.className="sr-only",s.textContent="Add Row",l=o.appendChild(document.createElement("tr")),l.id=n.id+"-template",l.className="hide",$.each(i.fields,function(e,i){var a=l.appendChild(document.createElement("td"));a.className="form-group",a.className+=i.addclass?" "+i.addclass:"",i.grid="template",d.addformfield(d,i,a),d.addfieldvalidation(t,i)}),c=l.appendChild(document.createElement("td")),c.className="text-right",a=c.appendChild(document.createElement("button")),a.type="button",a.className="btn btn-default grid-minus",s=a.appendChild(document.createElement("span")),s.className="glyphicon glyphicon-minus",s=s.appendChild(document.createElement("span")),s.className="sr-only",s.textContent="Remove Row"},cot_form.prototype.processField=function(e,t,i,a){var d,n,r=this,o=i.fields.length,l=1==o?"col-xs-12":2==o?"col-xs-12 col-sm-6":3==o?"col-xs-12 col-md-4":"col-xs-12 col-sm-6 col-md-3",s=e.appendChild(document.createElement("div"));s.id=a.id+"Element",s.className=a.className||l,s.className+=" form-group form-group-",s.className+=a.orientation||"vertical",s.className+=a.addclass?" "+a.addclass:"",oFieldDiv=s.appendChild(document.createElement("div")),["html","button"].indexOf(a.type)==-1&&(["static","checkbox","radio"].indexOf(a.type)>-1?a.title&&(d=oFieldDiv.appendChild(document.createElement("span")),d.className="staticlabel",d.textContent=a.title+(a.required||"static"==a.type?"":" (optional)")):(d=oFieldDiv.appendChild(document.createElement("label")),d.className="control-label",d.htmlFor=a.id,n=d.appendChild(document.createElement("span")),n.textContent=a.title+(a.required?"":" (optional)"),a.infohelp&&(n=d.appendChild(document.createElement("span")),n.className="glyphicon glyphicon-info-sign",n.setAttribute("data-toggle","tooltip"),n.setAttribute("data-placement","top"),n.title=a.infohelp))),r.addprehelptext(a,oFieldDiv),r.addformfield(r,a,oFieldDiv),r.addposthelptext(a,oFieldDiv),r.addfieldvalidation(t,a)},cot_form.prototype.addprehelptext=function(e,t){if(e.prehelptext){var i=t.appendChild(document.createElement("p"));i.className="helptext",i.innerHTML=e.prehelptext}},cot_form.prototype.addformfield=function(e,t,i){var a=e.callFunction(e[t.type+"FieldRender"],t,i);i.appendChild(a)},cot_form.prototype.addposthelptext=function(e,t){if(e.posthelptext){var i=t.appendChild(document.createElement("p"));i.className="helptext",i.innerHTML=e.posthelptext}},cot_form.prototype.addfieldvalidation=function(e,t){e.fields[t.id]={},e.fields[t.id].validators={},(t.validators||t.required)&&t.validators&&(e.fields[t.id].validators=t.validators),"Phone"==t.validationtype&&(e.fields[t.id].validators.callback={},e.fields[t.id].validators.callback.message="This field must be a valid phone number. (###-###-####)",e.fields[t.id].validators.callback.callback=function(e,i,a){return IEversion<10?!t.required&&""===e||!!e.match(/\d{3}-?\d{3}-?\d{4}/)&&(e.match(/\d{3}-?\d{3}-?\d{4}/)[0]==e&&(a.val(e.replace(/(\d{3})\-?(\d{3})\-?(\d{4})/,"$1-$2-$3")),!0)):""===e||a.intlTelInput("isValidNumber")}),"Email"==t.validationtype&&(e.fields[t.id].validators.emailAddress={message:"The value is not a valid email address"}),"URL"==t.validationtype&&(e.fields[t.id].validators.uri={message:"The value is not a valid URL (http://xx.xx or https://xx.xx)."}),"PostalCode"==t.validationtype&&(e.fields[t.id].validators.regexp={regexp:/^(?!.*[DFIOQU])[A-VXY][0-9][A-Z] ?[0-9][A-Z][0-9]$/i,message:"This field must be a valid postal code"}),t.required&&(e.fields[t.id].validators.notEmpty={},e.fields[t.id].validators.notEmpty.message=t.title+" is required and cannot be left blank"),"daterangepicker"==t.type&&(sFMT="DD/MM/YYYY",t.options&&t.options.format&&(sFMT=t.options.format),e.fields[t.id].validators.date={},e.fields[t.id].validators.date.format=sFMT,e.fields[t.id].validators.date.message="The date must be in the format"+sFMT)},cot_form.prototype.callFunction=function(e){return e.apply(this,Array.prototype.slice.call(arguments,1))},cot_form.prototype.staticFieldRender=function(e,t){var i=document.createElement("p");return i.name=e.grid?"row[0]."+e.id:e.id,i.textContent=e.value,i},cot_form.prototype.htmlFieldRender=function(e,t){var i=document.createElement("div");return i.name=e.grid?"row[0]."+e.id:e.id,i.innerHTML=e.html,i},cot_form.prototype.textFieldRender=function(e,t,i){var a=t.appendChild(document.createElement("div"));a.className="entryField";var d=a.appendChild(document.createElement("input"));return e.htmlAttr&&$(d).attr(e.htmlAttr),d.title=e.title,d.type=i||"text",d.value=e.value?e.value:"",d.disabled=!!e.disabled&&"disabled",e.grid?(d.name="row["+e.grid+"]."+e.id,$(d).attr("aria-labelledby",e.gridlabel)):(d.name=e.id,d.id=e.id),e.required?(d.setAttribute("aria-required","true"),d.setAttribute("data-fv-notempty","true"),d.setAttribute("data-fv-notempty-message","The "+e.title+" field is required and must be filled in before submission."),d.className="form-control required"):d.className="form-control","Phone"==e.validationtype?(d.placeholder="416-555-1212",d.className+=" phonevalidation "):d.placeholder=e.placeholder?e.placeholder:"",a},cot_form.prototype.passwordFieldRender=function(e,t){return this.textFieldRender(e,t,"password")},cot_form.prototype.radioFieldRender=function(e){var t=document.createElement("fieldset");t.className="form-control",e.required&&t.setAttribute("aria-required","true");var i=t.appendChild(document.createElement("legend"));return i.className="sr-only",i.textContent="Select an option for "+e.id,$.each(e.choices,function(i,a){var d=t.appendChild(document.createElement("label"));d.className=e.orientation?e.orientation:"vertical",d.className+=" entryField radioLabel";var n=d.appendChild(document.createElement("input"));e.grid?(n.name="row["+e.grid+"]."+e.id,$(n).attr("aria-labelledby",e.gridlabel)):(n.name=e.id,n.id=e.id+"_"+i),n.title=e.title,n.type="radio",n.className=e.required?"required":"",n.value=a.hasOwnProperty("value")?a.value:a.text,n.disabled=!!e.disabled&&"disabled",e.value&&(n.checked=e.value==n.value?"checked":""),d.appendChild(document.createElement("span")).innerHTML=a.text}),t},cot_form.prototype.checkboxFieldRender=function(e){var t=document.createElement("fieldset");t.className="form-control",e.required&&t.setAttribute("aria-required","true");var i=t.appendChild(document.createElement("legend"));return i.className="sr-only",i.textContent="Select options for "+e.id,$.each(e.choices,function(i,a){var d=t.appendChild(document.createElement("label"));d.className=e.orientation?e.orientation:"vertical",d.className+=" entryField checkboxLabel";var n=d.appendChild(document.createElement("input"));e.grid?(n.name="row["+e.grid+"]."+e.id,$(n).attr("aria-labelledby",e.gridlabel)):(n.name=e.id,n.id=e.id+"_"+i),n.title=e.title,n.type="checkbox",n.className=e.required?"required":"",n.value=a.hasOwnProperty("value")?a.value:a.text,n.disabled=!!e.disabled&&"disabled",a.selected&&(n.checked="checked"),d.appendChild(document.createElement("span")).innerHTML=a.text}),t},cot_form.prototype.dropdownFieldRender=function(e){var t=document.createElement("div");t.className="entryField";var i=t.appendChild(document.createElement("select"));return e.required&&i.setAttribute("aria-required","true"),e.grid?(i.name="row["+e.grid+"]."+e.id,$(i).attr("aria-labelledby",e.gridlabel)):(i.name=e.id,i.id=e.id),i.className="form-control",$.each(e.choices,function(t,a){var d=i.appendChild(document.createElement("option"));d.value=a.hasOwnProperty("value")?a.value:a.text,d.text=a.text,e.value&&(d.selected=e.value==d.value?"selected":"")}),i.disabled=!!e.disabled&&"disabled",t},cot_form.prototype.multiselectFieldRender=function(e){var t=document.createElement("div");t.className="entryField";var i=t.appendChild(document.createElement("select"));return e.required&&i.setAttribute("aria-required","true"),e.grid?(i.name="row["+e.grid+"]."+e.id,$(i).attr("aria-labelledby",e.gridlabel)):(i.name=e.id,i.id=e.id),i.className="form-control hide multiselect "+e.id,i.multiple=e.multiple?"multiple":"",$.each(e.choices,function(e,t){var a=i.appendChild(document.createElement("option"));a.value=t.hasOwnProperty("value")?t.value:t.text,a.text=t.text}),i.disabled=!!e.disabled&&"disabled",t},cot_form.prototype.daterangepickerFieldRender=function(e){var t=document.createElement("input");return e.grid?(t.name="row["+e.grid+"]."+e.id,$(t).attr("aria-labelledby",e.gridlabel)):(t.name=e.id,t.id=e.id),t.type="text",t.value=e.value?e.value:"",t.className=e.required?"form-control required daterangevalidation":"form-control daterangevalidation",e.required&&t.setAttribute("aria-required","true"),t.disabled=!!e.disabled&&"disabled",t},cot_form.prototype.datetimepickerFieldRender=function(e){var t=document.createElement("div");t.className="input-group date entryField datetimepicker "+e.id,t.setAttribute("data-refid",e.id);var i=t.appendChild(document.createElement("input"));i.type="text",e.required?(i.setAttribute("aria-required","true"),i.setAttribute("data-fv-notempty","true"),i.setAttribute("data-fv-notempty-message","The "+e.title+" field is required and must be filled in before submission."),i.className="form-control required"):i.className="form-control",i.value=e.value?e.value:"",e.grid?(i.name="row["+e.grid+"]."+e.id,$(i).attr("aria-labelledby",e.gridlabel)):(i.name=e.id,i.id=e.id),i.className="form-control";var a=t.appendChild(document.createElement("span"));return a.className="input-group-addon",a=a.appendChild(document.createElement("span")),a.className="glyphicon glyphicon-calendar",i.disabled=!!e.disabled&&"disabled",t},cot_form.prototype.textareaFieldRender=function(e){var t=document.createElement("div");t.className="entryField";var i=t.appendChild(document.createElement("textarea"));return e.grid?(i.name="row["+e.grid+"]."+e.id,$(i).attr("aria-labelledby",e.gridlabel)):(i.name=e.id,i.id=e.id),e.cols&&(i.cols=e.cols),e.rows&&(i.rows=e.rows),i.title=e.title,i.type="text",i.className+=e.required?"form-control required":"form-control",e.required&&i.setAttribute("aria-required","true"),i.placeholder=e.placeholder?e.placeholder:"",i.value=e.value?e.value:"",i.disabled=!!e.disabled&&"disabled",t},cot_form.prototype.buttonFieldRender=function(e){var t=document.createElement("button");t.type="button",e.className&&!e.btnClass?t.className=e.className:t.className="btn btn-"+(e.btnClass||"success");var i=t.appendChild(document.createElement("span"));return i.className=e.glyphicon?"glyphicon "+e.glyphicon:"",i=t.appendChild(document.createElement("span")),i.textContent=e.title,t.disabled=!!e.disabled&&"disabled",$(t).on("click",e.onclick||function(){}),t},CotForm.prototype.render=function(e){if(this._isRendered)throw new Error("This form is already rendered");"string"==typeof e&&(e={target:e}),this.cotForm.render(e),this._isRendered=!0,this._useBinding&&(this._model&&this._fillFromModel(),this._watchChanges())},CotForm.prototype.setModel=function(e){if(e&&"function"!=typeof e.get)throw new Error("Model must be a CotModel object");this._model=e,this._fillFromModel()},CotForm.prototype._fillFromModel=function(e){var t=this;this._isRendered&&(this._definition.sections||[]).forEach(function(e){(e.rows||[]).forEach(function(e){(e.fields||[]).forEach(function(e){if(e.bindTo){var i=t._model?t._model.get(e.bindTo)||"":"";["radio","checkbox"].indexOf(e.type)>-1?$.makeArray(i).forEach(function(t){var i=$('input[name="'+e.id+'"][value="'+t+'"]');i.length&&(i[0].checked=!0)}):$("#"+e.id).val(i)}})})})},CotForm.prototype._watchChanges=function(){var e=this;this._isRendered&&(this._definition.sections||[]).forEach(function(t){(t.rows||[]).forEach(function(t){(t.fields||[]).forEach(function(t){t.bindTo&&("radio"==t.type?$('input[name="'+t.id+'"]').on("click",function(i){e._model&&e._model.set(t.bindTo,$(i.currentTarget).val())}):"checkbox"==t.type?$('input[name="'+t.id+'"]').on("click",function(i){if(e._model){var a=$(i.currentTarget).val(),d=$.makeArray(e._model.get(t.bindTo)||[]).slice(),n=d.indexOf(a);i.currentTarget.checked&&n==-1?d.push(a):!i.currentTarget.checked&&n>-1&&d.splice(n,1),e._model.set(t.bindTo,d)}}):$("#"+t.id).on("change",function(i){e._model&&e._model.set(t.bindTo,$(i.currentTarget).val())}))})})})},CotForm.prototype.getData=function(){var e={},t={};return $.each($("#"+this.cotForm.id).serializeArray(),function(i,a){if(a.name.indexOf("row[")!==-1){var d=a.name.substring(a.name.indexOf("[")+1,a.name.indexOf("]"));if("template"!==d){var n=e.rows||[],r=t[d];void 0===r&&(n.push({}),r=n.length-1,t[d]=r),n[r][a.name.split(".")[1]]=a.value,e.rows=n}}else e.hasOwnProperty(a.name)?(e[a.name]=$.makeArray(e[a.name]),e[a.name].push(a.value)):e[a.name]=a.value}),e};